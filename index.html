<!DOCTYPE html>
<meta name="robots" content="noindex">
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>NHL Standings Generator</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.29.3/css/theme.default.min.css" />

<style id="css">
  body {
    font-family: sans-serif;
  }

  table th {
    text-align: left;
  }

  label {
  display: inline-block;
  min-width: 10em;
  }
  .label-text {
  display: inline-block;
  min-width: 4.5em;
  }
</style>
</head>
<body>
<script src="https://code.jquery.com/jquery-3.1.0.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sheetrock/1.1.4/dist/sheetrock.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.29.3/js/jquery.tablesorter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.29.3/js/jquery.tablesorter.widgets.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-deserialize@2.0.0-rc1/src/jquery.deserialize.min.js"></script>

  <h1>NHL Standings Generator</h1>
  <p>So, you hate the way the NHL points system currently works and think you can do better. Now's your chance!</p>
  <form id="diy" method="get">
  <p><label>Data Source: 
    <select id="dataSrc" name="dataSrc">
      <option value="201718">2017-18 (Updated 2018-01-18)</option>
      <option value="201617">2016-17</option>
    </select></label></p>
  
  <h3>DIY Points</h3>
  <p>
    <label><span class="label-text">Reg win:</span> <input id="winRG" name="winRG" size="2" value="3" /></label> 
    <label><span class="label-text">OT win:</span> <input id="winOT" name="winOT" size="2" value="2" /></label>
    <label><span class="label-text">SO win:</span> <input id="winSO" name="winSO" size="2" value="2" /></label>
  </p>
    <p>
    <label><span class="label-text">Reg loss:</span> <input id="lossRG" name="lossRG" size="2" value="0" /></label> 
    <label><span class="label-text">OT loss:</span> <input id="lossOT" name="lossOT" size="2"  value="1"/></label> 
    <label><span class="label-text">SO loss:</span> <input id="lossSO" name="lossSO" size="2" value="1" /></label> 
  </p>
  <p><label>Group By: <select id="group" name="group"><option>League</option><option>Conference</option><option>Division</option><option>Wild Card</option></select></label></p> 
  <p><button id="calculate">Generate Standings</button> <input type="reset" value="Reset Form" /></p>
  </form>
  
  <table id="statistics" class="tablesorter tablesorter-default"></table>
  <p>With apologies to Montr&eacute;al fans - my JSON interpreter really hates Unicode for some reason.</p>
  <h2>How This Works</h2>
  <p><ol>
    <li>I download a JSON file of the NHL schedule, which includes data on goals scored, final period, etc</li>
    <li>I parse this data (using JQ) into a new JSON file, determining what kind of win each game had and calculating the actual goals scored (no shootout wins), then adding up all this data</li>
    <li>I upload (manually, for now) this data to GitHub, and it's used to populate this page</li>
  </ol>
  
<script id="javascript">
var datasource = { "201718": "./data/results_2017-10-01_2018-07-01.json",
"201617": "./data/results_2016-10-01_2017-07-01.json"
};

$(document).ready( function() {
  $('#dataSrc').change( function() { this.form.submit(); } );
  if ( location.search.substr( 1 ) ) { 
  $('form#diy').deserialize( location.search.substr( 1 ) );
  }
  $('form#diy').on( "submit", function( e ) {
    e.preventDefault();
    if ( $('#group').val() == "Wild Card") { 
      playoffs();
    }
    else {
      calculate();
    }
    history.pushState($( this ).serialize(), "", '?' + $( this ).serialize());
  }).submit();
  $('form#diy').on('reset', function(e){
      history.pushState('', '', '?');
  });
});

var displayFields = [ 'name', 'GP', 'wins', 'winsRG', 'winsOT', 'winsSO', 'losses', 'lossesRG', 'lossesOT', 'lossesSO', 'goalsRG', 'goalsOT', 'goalsNHL', /*'goalsAgainstRG', 'goalsAgainstOT', 'goalsAgainstNHL',*/ 'NHLPoints', 'CustomPoints'];

function calculate( ) {
  $('#statistics').empty();
  var dataSrc = datasource[ $('#dataSrc').val() ];
  var division = 'division';
  var conference = 'conference';
  $.get( { url: dataSrc, dataType: 'json', success: function(data) { 
    var output = "";
    output += "<thead><tr><th>" + displayFields.join("</th><th>") + "</th></tr></thead>";

    $.each( data.results, function( index, team) {
        switch ( $('#group').val() ) {
          case 'Conference': 
            if ( conference != team.conference) {
                conference = team.conference;
                output += "</tbody><tbody class=\"tablesorter-no-sort\"><tr class=\"conference\"><th colspan=\"" + displayFields.length + "\">" + conference + "</th></tr></tbody><tbody>";
            }                       
          break;
          case 'Division':
            if ( division != team.division) {
                division = team.division;
                output += "</tbody><tbody class=\"tablesorter-no-sort\"><tr class=\"division\"><th colspan=\"" + displayFields.length + "\">" + division + "</th></tr></tbody><tbody>";
            }           
          break;
          default:
        }
        team['NHLPoints'] = calculateNHLPoints(team);
        team['CustomPoints'] = calculateCustomPoints(team);
        
        var cells = displayFields.map( function(key) { return team[key]; });
        output += "<tr><td>" + cells.join("</td><td>") + "</td></tr>";
    } );
    $('#statistics').html(output);
    $('#statistics').tablesorter({ 
            sortInitialOrder: 'desc',
            widgets : ['zebra','columns']
        });
    $("#statistics").trigger("updateAll"); 
  } } );
}

function playoffs() {

  $('#statistics').empty();
  var dataSrc = datasource[ $('#dataSrc').val() ];
  var teams = new Object();
  $.get( { url: dataSrc, dataType: 'json', success: function(data) { 
    var output = "";
    
    //Reformatting by Conference and Division
    $.each( data.results, function( index, team) { 
      if ( !teams[team.conference] ) {
        teams[team.conference] = new Object();
      }
      if ( !teams[team.conference][team.division] ) {
        teams[team.conference][team.division] = [];
      }
      team['winsROW'] = team['winsRG'] + team['winsOT'];
      team['goalDiff'] = team['goals'] - team['goalsAgainst'];
      team['NHLPoints'] = calculateNHLPoints(team);
      team['CustomPoints'] = calculateCustomPoints(team);
      teams[team.conference][team.division].push( team );
    });
    
    var playoffs = new Object();
    $.each( teams, function( conference, divisions) { 
      playoffs[conference] = new Object();
      var wildcard = [];
      $.each( divisions, function( division, teams ) {
        teams = teams.sort( sortByNHLPoints );
        playoffs[conference][division] = teams.slice(0,3); //Top 3 of each division
        wildcard = wildcard.concat( teams.slice(3) ); //Store everyone else in here temporarily
      } );
      wildcard = wildcard.sort( sortByNHLPoints );
      playoffs[conference]["Wild Card"] = wildcard.slice(0, 2);
      playoffs[conference]["Other"] = wildcard.slice(2);
    } );
    output = "<thead><tr><th>" + displayFields.join("</th><th>") + "</th></tr></thead>";
    
    $.each( playoffs, function( conference, positions ) {
      output += "<tbody class=\"tablesorter-no-sort\"><tr class=\"conference\"><th colspan=17>" + conference + "</th></tr></tbody>";
      $.each( positions, function( label, values ) {
          output += "<tbody class=\"tablesorter-no-sort\"><tr class=\"division\"><th colspan=17>" + label + "</th></tr></tbody>";
          output += "<tbody>";
          var even = true;
          $.each( values, function( index, value ) {
              var cells = displayFields.map( function(key) { return value[key]; });

              output += "<tr class=\"" + ( ( even ) ? "odd" : "even" ) +"\"><td>" + cells.join("</td><td>") + "</td></tr>";
              even = !even;
          } );
          output += "</tbody>";
      } );
    });
    
    $('#statistics').html(output); 
    
  } } );  
  
}

function sortByCustomPoints( a, b ) {
  var tieBreakers = ['CustomPoints', 'GP', 'winsROW', 'goalDiff'];
  return sortByPoints( a, b, tieBreakers);
}

function sortByNHLPoints( a, b ) {
  var tieBreakers = ['NHLPoints', 'GP', 'winsROW', 'goalDiff'];
  return sortByPoints( a, b, tieBreakers);
}

function sortByPoints( a, b, tieBreakers ) {
  for ( var i = 0; i < tieBreakers.length; i++ ) {
    var compare = b[tieBreakers[i]] - a[tieBreakers[i]];
    if ( ( compare ) != 0 ) {
      return compare;
    }
  }
  return 0;
}

function calculateNHLPoints( teamRecord ) {
  return 2 * teamRecord.wins + teamRecord.lossesOT + teamRecord.lossesSO;
}

function calculateCustomPoints( teamRecord ) {
  //Doing some very basic data sanitization
  var fieldNames = [ 'winRG', 'winOT', 'winSO', 'lossRG', 'lossOT', 'lossSO' ];
  var fieldValues = new Object();
  fieldNames.forEach( function( field ) { 
    fieldValues[field] = Number( $('#' + field).val() );  
    if ( isNaN( fieldValues[field] ) ) { 
      fieldValues[field] = 0;
      $('#' + field).val( 0 )
    }
  } );
  
  var customPoints = 0;
  customPoints += fieldValues.winRG * teamRecord.winsRG;
  customPoints += fieldValues.winOT * teamRecord.winsOT;
  customPoints += fieldValues.winSO * teamRecord.winsSO;
  customPoints += fieldValues.lossRG * teamRecord.lossesRG;
  customPoints += fieldValues.lossOT * teamRecord.lossesOT;
  customPoints += fieldValues.lossSO * teamRecord.lossesSO;
  
  return customPoints;
}      
</script>
</body>
</html>
