<!DOCTYPE html>
<meta name="robots" content="noindex">
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>NHL Standings Generator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.29.3/css/theme.default.min.css" />
  <link rel="stylesheet" href="styles/style.css" />
  <link rel="stylesheet" href="styles/nhl_teams.css" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</head>
<body>
<script src="https://code.jquery.com/jquery-3.1.0.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sheetrock/1.1.4/dist/sheetrock.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.29.3/js/jquery.tablesorter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.29.3/js/jquery.tablesorter.widgets.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-deserialize@2.0.0-rc1/src/jquery.deserialize.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.19.0/URI.min.js"></script>

<div id="container">
<div id="content">
  <h1>NHL Standings Generator</h1>
  <p>So, you hate the way the NHL points system currently works and think you can do better. Now's your chance!</p>
  <form id="diy" method="get">
  <p><label>Data Source: 
    <select id="dataSrc" name="dataSrc">
      <option value="201718">2017-18</option>
      <option value="201617">2016-17</option>
      <option value="201516">2015-16</option>
    </select></label><br /><small>Last updated: <span id="dataLastUpdated"></span> UTC</small></p>
  
  <h3>DIY Points</h3>
  <p>
    <label><span class="label-text">Reg win:</span> <input id="winRG" name="winRG" size="2" value="3" /></label> 
    <label><span class="label-text">OT win:</span> <input id="winOT" name="winOT" size="2" value="2" /></label>
    <label><span class="label-text">SO win:</span> <input id="winSO" name="winSO" size="2" value="2" /></label>
  </p>
    <p>
    <label><span class="label-text">Reg loss:</span> <input id="lossRG" name="lossRG" size="2" value="0" /></label> 
    <label><span class="label-text">OT loss:</span> <input id="lossOT" name="lossOT" size="2"  value="1"/></label> 
    <label><span class="label-text">SO loss:</span> <input id="lossSO" name="lossSO" size="2" value="1" /></label> 
  </p>
  <p><button id="calculate">Generate Standings</button> <input type="reset" value="Reset Form" /></p>
  
 <div id="tabs">
  <ul>
    <li><a href="#standings-panel">League</a></li>
    <li><a href="#standings-panel">Conference</a></li>
    <li><a href="#standings-panel">Division</a></li>
    <li><a href="#wildcard-panel">Wild Card</a></li>
    <li><a href="#playoffs-panel">Playoffs</a></li>
  </ul>
  
  <div id="standings-panel">
    <table id="standings" class="tablesorter tablesorter-default"></table>
  </div>
  <div id="wildcard-panel">
    <p><small>Sorted by your custom points system.</small></p>
    <table id="wildcard" class="tablesorter tablesorter-default"></table>
  </div>
  <div id="playoffs-panel">
    <p><small>Sorted by your custom points system.</small></p>
      <p><label>Generate By: 
        <select id="playoffs-group" name="playoffs-group">
          <option value="conference">Top 8 per conference</option>
          <option value="league">Top 16 in League</option>
          <option value="wildcard">Wild Card</option>
          <option value="fiegi">FIEGI (per Dave Lozo)</option>
        </select></label> <button id="update">Update</button></p>
    <div id="playoffs-bracket"></div>
    <table id="playoffs" class="tablesorter tablesorter-default"></table>
  </div>
</div> 
</form>
  <hr />
  <h2>How This Works</h2>
  <ol>
    <li>I download a JSON file of the NHL schedule, which includes data on goals scored, final period, etc</li>
    <li>I parse this data (using <a href="https://stedolan.github.io/jq/">JQ</a>) into a new JSON file, determining what kind of win each game had and calculating the actual goals scored (no shootout wins), then adding up all this data</li>
    <li>The results for the current season are automatically updated at 10:00 AM UTC every day.</li>
  </ol>
  <p>Tie-breakers are points, games played, wins (regulation + overtime), then goal differential. The NHL also takes into account the team vs team record, but that was too complicated to implement.</p>
  <hr />
  <h2>Frequently Asked Questions</h2>
  
  <h3>How do I use this?</h3>
  <p>Enter your preferred points weightings for each type of game final result, then click "Generate Standings". Each tab presents a different type of standings, with the final tab presenting the playoff matchups. You can choose alternative playoff formats on that tab.</p>
  
  <h3>Why did you make this?</h3>
  <p>I was hearing a lot of talk about the "loser point", proposed three point systems and alternative playoff formats, but couldn't find any up to date representations of what the current standings would look like under those systems. Being currently unemployed and wanting to get my hands dirty with some Javascript, I made this page.</p>
  
  <h3>What about ties?</h3>
  <p>The current NHL doesn't have ties, so I didn't feel it made sense to explicitly support them here. Try giving shootouts the same number of points for the winner and loser.</p>
  
  <h3>But teams would play differently if a regulation win were worth more points!</h3>
  <p>Of course! But I wouldn't have a clue how to simulate that in this table.</p>
  
  <hr />
  <h2>About the Author</h2>
  <p>Australian and Canadian, back in Australia after a number of years in Vancouver BC. Listener of many hockey podcasts. Questions and comments to ahockeyscript@gmail.com. Twitter: <a href="http://twitter.com/ahockeyscript">@ahockeyscript</a>.</p>
  
  <p>See also: <a href="https://ahockeyscript.github.io/hockey-browser-tools/">Hockey Browser Tools</a>, where you can find various scripts that can be used to tweak your browser into providing a different NHL.com experience.</p>
</div> <!-- #content -->
</div> <!-- #container -->
<script id="javascript">
var dataSources = { "201718": "./data/results_2017-10-01_2018-07-01.json",
"201617": "./data/results_2016-10-01_2017-07-01.json",
"201516": "./data/results_2015-10-01_2016-07-01.json"
};

var dataSrc;

var tabsInfo = new Object();

$(document).ready( function() {
  var url = new URI( location );
  
  $('#tabs > ul > li').each( function( i, el ) { tabsInfo[ activeTabName( $(el) )] = i; } );
  
  updateDataSource();
  var activeTab = 0;
  if ( url.query() ) { 
    var query = url.query( true );
    $('form#diy').deserialize( url.query() );
    if ( query.tab ) {
      activeTab = tabsInfo[query.tab];
    }
  }
  $( "#tabs" ).tabs({ active: activeTab });
  $('form#diy').on( "submit", function( e ) {
    e.preventDefault();
    updateDataSource();
    if ( $('#tabs').tabs("option", "active") == 3 ) { 
      playoffs();
    }
    if ( $('#tabs').tabs("option", "active") == 4 ) { 
      playoffs( $('#playoffs-group').val());
    }
    else {
      calculate();
    }
    history.pushState( '', '', '?' + $( this ).serialize() + '&tab=' + activeTabName() );
  }).submit();
  $('form#diy').on('reset', function(e){
      history.pushState('', '', '?');
  });
  
  $( "#tabs" ).on( "tabsactivate", function( event, ui ) {
    url.setQuery('tab', activeTabName(ui.newTab) );
    history.pushState('', '', '?' + url.query());
    if (activeTabName(ui.newTab) == 'wildcard' ) { 
      playoffs();
    }
    else if (activeTabName(ui.newTab) == 'playoffs' ) { 
      playoffs( $('#playoffs-group').val());
    }
    else {
      calculate();
    }
  } );
  
  $('#dataSrc').change( function() { updateDataSource(); } );

});

function activeTabName( tab ) {
  if ( !tab ) {
    tab = $('#tabs').find("li[role=tab]").eq( $('#tabs').tabs('option', 'active') );
  }
  return tab.text().toLowerCase().replace(/\s+/g, '');
}

function updateDataSource( ) {
  dataSrc = dataSources[ $('#dataSrc').val() ];
  fetchData( function(data) { $('#dataLastUpdated').html( data.lastModified) } );
}

function fetchData( callback ) {
  $.ajax({
    url: dataSrc,
    dataType: 'json',
    headers: { 'Cache-Control': 'max-age=600, public' },
    success: function (response) {
        callback(response);
    },
  });
}

var displayFields = [ 'name', 'GP', 'wins', 'winsRG', 'winsOT', 'winsSO', 'losses', 'lossesRG', 'lossesOT', 'lossesSO', 'goalsRG', 'goalsOT', 'goalsNHL', /*'goalsAgainstRG', 'goalsAgainstOT', 'goalsAgainstNHL',*/ 'NHLPoints', 'CustomPoints'];

function calculate( ) {
  $('#standings').empty();
  var division = 'division';
  var conference = 'conference';
  fetchData( function(data) { 
    var output = "";
    output += "<thead><tr><th>" + displayFields.join("</th><th>") + "</th></tr></thead>";

    $.each( data.results, function( index, team) {
        switch ( activeTabName() ) {
          case "conference": 
            if ( conference != team.conference) {
                conference = team.conference;
                output += "</tbody><tbody class=\"tablesorter-no-sort\"><tr class=\"conference\"><th colspan=\"" + displayFields.length + "\">" + conference + "</th></tr></tbody><tbody>";
            }                       
          break;
          case "division":
            if ( division != team.division) {
                division = team.division;
                output += "</tbody><tbody class=\"tablesorter-no-sort\"><tr class=\"division\"><th colspan=\"" + displayFields.length + "\">" + division + "</th></tr></tbody><tbody>";
            }           
          break;
          default:
        }
        team['NHLPoints'] = calculateNHLPoints(team);
        team['CustomPoints'] = calculateCustomPoints(team);
        
        var cells = displayFields.map( function(key) { return team[key]; });
        output += "<tr><td>" + cells.join("</td><td>") + "</td></tr>";
    } );
    $('#standings').html(output);
    $('#standings').tablesorter({ 
            sortInitialOrder: 'desc',
            widgets : ['zebra','columns'],
            sortList: [[0,0]]
        });
    $("#standings").trigger("updateAll"); 
  } );
}

function playoffs( type = "wildcard", leaders = 3 ) {

  if ( 'fiegi' == type) { playoffs_fiegi(); return; }
  
  $('#playoffs').empty();
  var teamsByDivision = new Object();
  var teamsByConference = new Object();
  var teamsAll = new Array();
  var wildcardSlots = 2;
  
  fetchData( function(data) { 
    var output = "";
    
    //Reformatting by Conference and Division
    $.each( data.results, function( index, team) { 
      if ( !teamsByDivision[team.conference] ) {
        teamsByDivision[team.conference] = new Object();
      }
      if ( !teamsByDivision[team.conference][team.division] ) {
        teamsByDivision[team.conference][team.division] = [];
      }
      if ( !teamsByConference[team.conference] ) {
        teamsByConference[team.conference] = [];
      }
      
      team['winsROW'] = team['winsRG'] + team['winsOT'];
      team['goalDiff'] = team['goals'] - team['goalsAgainst'];
      team['NHLPoints'] = calculateNHLPoints(team);
      team['CustomPoints'] = calculateCustomPoints(team);
      teamsByDivision[team.conference][team.division].push( team );
      teamsByConference[team.conference].push( team );
      teamsAll.push( team );
    });
    
    var playoffs = new Object();
    
    switch ( type ) { 
      case 'wildcard':
        $.each( teamsByDivision, function( conference, divisions) { 
          playoffs[conference] = new Object();
          playoffs[conference]["playoffs"] = new Object();
          playoffs[conference]["nonplayoffs"] = [];
          var wildcard = [];
          $.each( divisions, function( division, teams ) {
            teams = teams.sort( sortByCustomPoints );
            playoffs[conference]["playoffs"][division] = teams.slice(0, leaders); //Top 3 of each division
            wildcard = wildcard.concat( teams.slice(leaders) ); //Store everyone else in here temporarily
          } );
          wildcard = wildcard.sort( sortByCustomPoints );
          playoffs[conference]["playoffs"]["Wild Card"] = wildcard.slice(0, wildcardSlots);
          playoffs[conference]["nonplayoffs"] = wildcard.slice(wildcardSlots);
        } );
      break;
    
      case 'conference': 
        leaders = 8;
        $.each( teamsByConference, function( conference, teams) { 
          teams = teams.sort( sortByCustomPoints );
          playoffs[conference] = new Object();
          playoffs[conference]["playoffs"] = teams.slice(0, leaders);
          playoffs[conference]["nonplayoffs"] = teams.slice(leaders);
        } );     
      break;
      
      case 'league':
        leaders = 16;
        teams = teamsAll.sort( sortByCustomPoints );
        playoffs = new Object();
        playoffs["playoffs"] = teams.slice(0, leaders);
        playoffs["nonplayoffs"] = teams.slice(leaders);     
      break;

      case 'division':
      
      break;
    }

    output = "<thead><tr><th>" + displayFields.join("</th><th>") + "</th></tr></thead>";
    
    if ( 'league' === type ) {
      output += printPlayoffsTable( playoffs );
    }
    else { 
      $.each( playoffs, function( conference, positions ) {
        output += "<tbody class=\"tablesorter-no-sort\"><tr class=\"conference\"><th colspan=17>" + conference + "</th></tr></tbody>";
        output += printPlayoffsTable( positions );
      });
    }
    
    if ( activeTabName() == 'wildcard') { 
      $('#wildcard').html(output); 
      return;
    }
    
    $('#playoffs').html(output);
    
    var output = "<h2>Playoff Matchups</h2>";
    output += "<div class=\"playoffs-matchups\">"; 
    switch ( type ) {
      case 'wildcard': 
        $.each( teamsByDivision, function( conference, divisions ) {
          output += "<div class=\"playoffs-conference\">";
          output += "<h3>" + conference + "</h3>";
          var conferenceTeams = teamsByConference[conference];
          conferenceTeams = conferenceTeams.sort( sortByCustomPoints );
          var conferenceLeader = conferenceTeams[0];
          $.each( divisions, function( division, teams ) { 
            output += "<h4>" + division + "</h4>";
            if ( division == conferenceLeader.division ) { 
              output += "<p><span class=\"team-name\">" + conferenceLeader.name + '</span> vs <span class=\"team-name\">' + playoffs[conference]['playoffs']['Wild Card'][1].name + " (WC2)</span></p>";
            }
            else {
              output += "<p><span class=\"team-name\">" + playoffs[conference]['playoffs'][division][0].name + '</span> vs <span class=\"team-name\">' + playoffs[conference]['playoffs']['Wild Card'][0].name + " (WC1)</span></p>";
            }
            output += "<p><span class=\"team-name\">" + playoffs[conference]['playoffs'][division][1].name + '</span> vs <span class=\"team-name\">' + playoffs[conference]['playoffs'][division][2].name + "</span></p>";
          });
          output += "</div>";
        } );
      break;
      case 'conference': 
        $.each( teamsByConference, function( conference, teams ) {
          output += "<div class=\"playoffs-conference\">";
          output += "<h3>" + conference + "</h3>";
          teams = teams.sort( sortByCustomPoints );
          var index = 0;
          var lastIndex = leaders -1;
          while ( index < lastIndex ) {
            output += "<p><span class=\"team-name\">" + teams[index].name + '</span> vs <span class=\"team-name\">' + teams[lastIndex].name + "</span></p>";
            index++;
            lastIndex--;
          }
          output += "</div>";
        });
      break;
      case 'league': 
        teams = teamsAll.sort( sortByCustomPoints );
        var index = 0;
        var lastIndex = leaders -1;
        while ( index < lastIndex ) {
          output += "<p><span class=\"team-name\">" + teams[index].name + '</span> vs <span class=\"team-name\">' + teams[lastIndex].name + "</span></p>";
          index++;
          lastIndex--;
        }
      break;
    }
    output += "</div>";

    $('#playoffs-bracket').html(output);
    
  } );  
  
}

function playoffs_fiegi( ) {
  var playoffs, teams;
  $('#playoffs-bracket').empty();
  $('#playoffs').empty();
  teams = new Array();
  
  fetchData( function(data) { 
    var output = "";
    
    $.each( data.results, function( index, team) {       
      team['winsROW'] = team['winsRG'] + team['winsOT'];
      team['goalDiff'] = team['goals'] - team['goalsAgainst'];
      team['NHLPoints'] = calculateNHLPoints(team);
      team['CustomPoints'] = calculateCustomPoints(team);
      teams.push( team );
    });
    
    teams = teams.sort( sortByCustomPoints );
    
    playoffs = new Object();
    playoffs["qualifying"] = teams.slice(-16);
    playoffs["round0"] = teams.slice(8, 16);    
    
    $.get( {
    url: './fiegi_template.html',
    dataType: 'text',
    success: function(response) {
      var $fiegi = $(response);
      var i = 0;
      for (i; i < teams.length; i++ ) {
        $('li .fiegi-seed-' + (i+1), $fiegi).find('.fiegi-team-name').empty().data('seed', i).append(teams[i].name + ' (' + (i+1) + ')' ).addClass('primary-bg--team-' + teams[i].id);
      }
      $('p .fiegi-seed-17', $fiegi).text(teams[16].name + ' (' + 17 + ')' );
      
      $('.fiegi-qualifying-round', $fiegi).on( 'fiegi:refresh', function() { 
        fiegi_complete_round( this, 7, '.fiegi-qualifying-seed-', teams) 
      });

      $('.fiegi-wild-card-round', $fiegi).on( 'fiegi:refresh', function() { 
        fiegi_complete_round( this, 8, '.fiegi-wild-card-seed-', teams);
      });

      $('.fiegi-round-1', $fiegi).on( 'fiegi:refresh', function() { 
        fiegi_complete_round( this, 8, '.fiegi-round1-seed-', teams); 
      });

      $('.fiegi-round-2', $fiegi).on( 'fiegi:refresh', function() { 
        fiegi_complete_round( this, 4, '.fiegi-round2-seed-', teams); 
      }); 

      $('.fiegi-round-3', $fiegi).on( 'fiegi:refresh', function() { 
        fiegi_complete_round( this, 2, '.fiegi-round3-seed-', teams);
      });

      $('.fiegi-round li > span', $fiegi).on('click', '.fiegi-team-name', function() { 
        fiegi_team_select( this, teams );
      });
      
      $('#playoffs-bracket').append($fiegi);
    },
  });
    
  });
}

function fiegi_team_select( el, teams ) {
  $(el).parents('li').find('.fiegi-team-name').removeClass('selected');
  $(el).addClass('selected');
  $(el).parents('.fiegi-round').trigger('fiegi:refresh');
}

function fiegi_complete_round( parentRound, seriesNum, targetClass, teams ) {
  var $selectedTeams = $( '.fiegi-team-name.selected', $(parentRound) );
  $selectedTeams.sort( function( a, b ) {
    a = parseInt( $(a).data('seed') );
    b = parseInt( $(b).data('seed') );
    return a - b;
  });
  if ( $selectedTeams.length == seriesNum ) {
    $selectedTeams.each( function( i, el) { 
      var $target = $( targetClass + (i+1), $(parentRound).parents('.fiegi-playoffs')).find('.fiegi-team-name');
      if ( $selectedTeams.eq(i).data('seed') != $target.data('seed') ) {
        $target.replaceWith( $(this).clone(true).off().removeClass('selected') );        
      }
    });
  }
  else {
    for ( var i = 0; i < seriesNum; i++ ) { 
      var $target = $( targetClass + (i+1), $(parentRound).parents('.fiegi-playoffs')).find('.fiegi-team-name:not(:empty)');
      $target.empty().removeData().attr('class', 'fiegi-team-name');        
    }
  }
  $(parentRound).next('.fiegi-round').trigger('fiegi:refresh');
}

function printPlayoffsTable( positions ) {
  var output = '';
  if ( Array.isArray( positions.playoffs ) ) { 
    output += printTableRows( positions.playoffs );
  }
  else {
    $.each( positions.playoffs, function( label, teams ) {
        output += "<tbody class=\"tablesorter-no-sort\"><tr class=\"division\"><th colspan=17>" + label + "</th></tr></tbody>";
        output += "<tbody>";
        output += printTableRows( teams );
        output += "</tbody>";
    } );
  }
  output += "<tbody class=\"non-playoff-teams\">";
  output += printTableRows( positions.nonplayoffs );
  output += "</tbody>";
  return output;
}

function printTableRows( teams ) {
  output = "";
  var even = true;
  $.each( teams, function( index, value ) {
      var cells = displayFields.map( function(key) { return value[key]; });
      output += "<tr class=\"" + ( ( even ) ? "odd" : "even" ) +"\"><td>" + cells.join("</td><td>") + "</td></tr>";
      even = !even;
  } );
  return output;
}

function sortByCustomPoints( a, b ) {
  var tieBreakers = ['CustomPoints', 'GP', 'winsROW', 'goalDiff'];
  return sortByPoints( a, b, tieBreakers);
}

function sortByNHLPoints( a, b ) {
  var tieBreakers = ['NHLPoints', 'GP', 'winsROW', 'goalDiff'];
  return sortByPoints( a, b, tieBreakers);
}

function sortByPoints( a, b, tieBreakers ) {
  for ( var i = 0; i < tieBreakers.length; i++ ) {
    var compare = ( tieBreakers[i] === 'GP' ) ? a[tieBreakers[i]] - b[tieBreakers[i]] : b[tieBreakers[i]] - a[tieBreakers[i]];
    if ( ( compare ) != 0 ) {
      return compare;
    }
  }
  return 0;
}

function calculateNHLPoints( teamRecord ) {
  return 2 * teamRecord.wins + teamRecord.lossesOT + teamRecord.lossesSO;
}

function calculateCustomPoints( teamRecord ) {
  //Doing some very basic data sanitization
  var fieldNames = [ 'winRG', 'winOT', 'winSO', 'lossRG', 'lossOT', 'lossSO' ];
  var fieldValues = new Object();
  fieldNames.forEach( function( field ) { 
    fieldValues[field] = Number( $('#' + field).val() );  
    if ( isNaN( fieldValues[field] ) ) { 
      fieldValues[field] = 0;
      $('#' + field).val( 0 )
    }
  } );
  
  var customPoints = 0;
  customPoints += fieldValues.winRG * teamRecord.winsRG;
  customPoints += fieldValues.winOT * teamRecord.winsOT;
  customPoints += fieldValues.winSO * teamRecord.winsSO;
  customPoints += fieldValues.lossRG * teamRecord.lossesRG;
  customPoints += fieldValues.lossOT * teamRecord.lossesOT;
  customPoints += fieldValues.lossSO * teamRecord.lossesSO;
  
  return customPoints;
}      
</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115774306-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115774306-1');
</script>

</body>
</html>
